<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Create Post</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <style>
        .ql-toolbar {
          border-radius: 8px 8px 0 0;
        }
        .ql-container {
          border-radius: 0 0 8px 8px;
          min-height: 300px;
        }
    </style>
</head>
<body class="bg-gray-100">

<div class="max-w-3xl mx-auto bg-white p-8 mt-10 shadow-lg rounded-2xl">
    <h1 class="text-3xl font-bold mb-4">Write a new post</h1>

    <form th:action="@{/create}" method="post" onsubmit="return submitPost()">
        <input type="text" name="title" placeholder="Enter your title"
               class="w-full border p-3 mb-4 rounded-lg text-xl focus:outline-none focus:ring" required>

        <!-- Editor -->
        <div id="editor" class="mb-4"></div>
        <input type="hidden" name="content" id="content">

        <button type="submit"
                class="px-6 py-3 bg-blue-600 text-white rounded-xl hover:bg-blue-700">
            Publish
        </button>
    </form>
</div>

<!-- Quill.js -->
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

<script>
    const quill = new Quill('#editor', {
      theme: 'snow',
      placeholder: 'Start writing your story...',
      modules: {
        toolbar: {
          container: [
            [{ 'header': [1, 2, 3, false] }],
            ['bold', 'italic', 'underline', 'strike'],
            [{ 'list': 'ordered'}, { 'list': 'bullet' }],
            ['blockquote', 'code-block'],
            ['link', 'image', 'video'],
            ['clean']
          ],
          handlers: {
            image: uploadFileHandler('image'),
            video: uploadFileHandler('video'),
            audio: uploadFileHandler('audio')
          }
        }
      }
    });

    // Function to upload files
    function uploadFileHandler(type) {
      return function() {
        const input = document.createElement('input');
        input.setAttribute('type', 'file');

        if (type === 'image') input.setAttribute('accept', 'image/*');
        if (type === 'video') input.setAttribute('accept', 'video/*');
        if (type === 'audio') input.setAttribute('accept', 'audio/*');

        input.click();
        input.onchange = async () => {
          const file = input.files[0];
          const formData = new FormData();
          formData.append("file", file);

          const res = await fetch('/upload', {
            method: 'POST',
            body: formData
          });
          const fileUrl = await res.text();

          const range = quill.getSelection(true);
          if (type === 'image') {
            quill.insertEmbed(range.index, 'image', fileUrl);
          } else if (type === 'video') {
            quill.insertEmbed(range.index, 'video', fileUrl);
          } else if (type === 'audio') {
            // Quill doesn't natively support audio, so we embed HTML manually
            quill.clipboard.dangerouslyPasteHTML(range.index, `<audio controls src="${fileUrl}"></audio>`);
          }
        };
      };
    }

    function submitPost() {
      document.getElementById('content').value = quill.root.innerHTML;
      return true;
    }
</script>

</body>
</html>
