<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>New Post | Substack Clone</title>
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <style>
        body {font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin:0;}
        .container {max-width: 700px; margin: 0 auto; padding: 2rem 1rem;}
        .toolbar {position:sticky; top:0; background:white; z-index:10; border-bottom:1px solid #eee; padding:1rem 0;}
        .btn {padding:8px 16px; border-radius:999px; font-weight:600; cursor:pointer;}
        .btn-draft {background:transparent; color:#666; border:1px solid #ddd;}
        .btn-preview {background:#fff; color:#ff5a00; border:1px solid #ff5a00;}
        .btn-continue {background:#ff5a00; color:white;}
        .title {font-size:3rem; font-weight:700; border:none; outline:none; width:100%; margin:2rem 0 .5rem;}
        .subtitle {font-size:1.5rem; color:#666; border:none; outline:none; width:100%; margin-bottom:1rem;}
        #editor {min-height:60vh; font-size:1.25rem; line-height:1.7;}
        .ql-editor {padding:0 !important;}
        .media-wrapper {position:relative; display:inline-block; margin:1rem 0;}
        .remove-btn {
          position:absolute; top:8px; right:8px; background:#ff5a00; color:white;
          border:none; border-radius:50%; width:28px; height:28px; font-size:16px;
          cursor:pointer; opacity:0; transition:opacity .2s;
        }
        .media-wrapper:hover .remove-btn {opacity:1;}
        .drop-zone {border:3px dashed #ff5a00; border-radius:12px; padding:40px; text-align:center;
                    background:#fff8f5; cursor:pointer; margin:2rem 0;}
        .drop-zone.dragover {background:#ffece5;}
        .progress {height:6px; background:#eee; border-radius:3px; margin-top:10px; overflow:hidden;}
        .progress-bar {height:100%; background:#ff5a00; width:0; transition:width .3s;}
    </style>
</head>
<body>
<div class="container">

    <!-- Top Bar -->
    <div class="toolbar" style="display:flex; justify-content:space-between; align-items:center;">
        <button class="btn btn-draft">← Draft</button>
        <div>
            <button class="btn btn-preview">Preview</button>
            <button class="btn btn-continue">Continue</button>
        </div>
    </div>

    <!-- Quill Toolbar -->
    <div id="toolbar">
        <select class="ql-header"><option value="1">Heading 1</option><option value="2">Heading 2</option><option selected>Normal</option></select>
        <button class="ql-bold"></button>
        <button class="ql-italic"></button>
        <button class="ql-link"></button>
        <button class="ql-image"></button>
        <button class="ql-video"></button>
        <button class="ql-list" value="ordered"></button>
        <button class="ql-list" value="bullet"></button>
    </div>

    <form th:action="@{/posts/save}" th:object="${post}" method="post">
        <input type="text" th:field="*{title}" class="title" placeholder="Title" required />
        <input type="text" th:field="*{subtitle}" class="subtitle" placeholder="Add a subtitle..." />

        <div class="author" style="display:flex; align-items:center; gap:8px; margin:2rem 0;">
            <img src="https://i.pravatar.cc/32" width="32" style="border-radius:50%;">
            <span style="font-weight:500;">vilas poojari</span><span style="color:#aaa;">+</span>
        </div>

        <!-- Quill Editor -->
        <div id="editor">
            <p>Start writing...</p>
            <div class="drop-zone" id="dropZone">
                Drop images or videos here<br><small>or click to upload</small>
                <div class="progress"><div class="progress-bar" id="progressBar"></div></div>
            </div>
        </div>
        <textarea th:field="*{content}" id="content" style="display:none;"></textarea>

        <input type="file" id="fileInput" accept="image/*,video/*" multiple style="display:none;">
        <button type="submit" id="saveBtn" style="display:none;">Save</button>
    </form>

    <div style="text-align:center; margin:2rem 0;">
        <a href="#" style="color:#666; font-size:0.9rem;">Edit email header/footer →</a>
    </div>
</div>

<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
<script>
    const quill = new Quill('#editor', {
      modules: { toolbar: '#toolbar' },
      theme: 'snow'
    });

    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');
    const progressBar = document.getElementById('progressBar');

    // ── UPLOAD ──
    dropZone.onclick = () => fileInput.click();
    ['dragenter','dragover'].forEach(e=>dropZone.addEventListener(e,()=>dropZone.classList.add('dragover')));
    ['dragleave','drop'].forEach(e=>dropZone.addEventListener(e,()=>dropZone.classList.remove('dragover')));
    dropZone.ondrop = e => { e.preventDefault(); handleFiles(e.dataTransfer.files); };
    fileInput.onchange = () => handleFiles(fileInput.files);

    function handleFiles(files) {
      [...files].forEach(file => {
        if (!file.type.match('image.*') && !file.type.match('video.*')) return;
        const formData = new FormData(); formData.append('file', file);

        const xhr = new XMLHttpRequest();
        xhr.open('POST', '/銷售/media', true);
        xhr.upload.onprogress = e => {
          if (e.lengthComputable) progressBar.style.width = (e.loaded / e.total)*100 + '%';
        };
        xhr.onload = () => {
          if (xhr.status === 200) {
            const {url} = JSON.parse(xhr.responseText);
            const range = quill.getSelection(true);
            const index = range ? range.index : quill.getLength();

            // Insert media with removable wrapper
            const wrapper = `<div class="media-wrapper">
              <button class="remove-btn" onclick="removeMedia(this)">×</button>
              ${file.type.startsWith('image')
                ? `<img src="${url}" style="max-width:100%; border-radius:8px;">`
                : `<video src="${url}" controls style="max-width:100%; border-radius:8px;"></video>`
              }
            </div><p></p>`;

            quill.clipboard.dangerouslyPasteHTML(index, wrapper);
            quill.setSelection(index + 1);
            progressBar.style.width = '0%';
          }
        };
        xhr.send(formData);
      });
    }

    // ── REMOVE ──
    window.removeMedia = function(btn) {
      const wrapper = btn.parentElement;
      const delta = quill.getContents();
      const ops = delta.ops;
      let deleteLength = 0;
      let found = false;

      // Find the exact blot (image/video) under the wrapper
      quill.getLines().forEach(line => {
        line.domNode.querySelectorAll('.media-wrapper').forEach(w => {
          if (w === wrapper) {
            const index = quill.getIndex(line);
            // count characters inside wrapper + the <p></p> after
            deleteLength = w.textContent.length + 2; // +2 for the empty <p>
            quill.deleteText(index, deleteLength);
            found = true;
          }
        });
      });
    };

    // ── SYNC & AUTO-SAVE ──
    document.querySelector('form').onsubmit = () => {
      document.getElementById('content').value = quill.root.innerHTML;
    };
    setInterval(() => document.getElementById('saveBtn').click(), 5000);
</script>
</body>
</html>